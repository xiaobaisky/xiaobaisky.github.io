class AlgoliaSearch{constructor(){this.searchInstance=null,this.isInitialized=!1,this.elements=this.cacheElements(),this.config=GLOBAL_CONFIG.algolia,this.init()}cacheElements(){return{searchMask:document.getElementById("search-mask"),searchDialog:document.querySelector("#algolia-search .search-dialog"),searchButton:document.querySelector("#search-button > .search"),closeButton:document.querySelector("#algolia-search .search-close-button"),menuSearch:document.getElementById("menu-search"),hitsContainer:document.getElementById("algolia-hits"),inputContainer:"#algolia-search-input",paginationContainer:"#algolia-pagination",statsContainer:"#algolia-tips > #algolia-stats"}}init(){try{if(!this.validateConfig())return void console.error("Algolia configuration is invalid!");this.setupSearchInstance(),this.bindEvents(),this.bindKeyboardShortcuts(),this.isInitialized=!0}catch(e){console.error("Algolia search initialization failed:",e)}}validateConfig(){return this.config&&this.config.appId&&this.config.apiKey&&this.config.indexName}setupSearchInstance(){this.searchInstance=instantsearch({indexName:this.config.indexName,searchClient:algoliasearch.algoliasearch(this.config.appId,this.config.apiKey),searchFunction:e=>this.handleSearch(e)}),this.addWidgets(),this.searchInstance.start()}handleSearch(e){e.state.query?(this.showLoading(),e.search()):this.clearResults()}showLoading(){if(this.elements.hitsContainer){const e=`<div class="loading">${GLOBAL_CONFIG.lang?.search?.loading||"Searching..."}</div>`;this.elements.hitsContainer.innerHTML=e}}clearResults(){this.elements.hitsContainer&&(this.elements.hitsContainer.innerHTML="")}addWidgets(){const e=[this.createConfigureWidget(),this.createSearchBoxWidget(),this.createStatsWidget(),this.createHitsWidget(),this.createPaginationWidget()];this.searchInstance.addWidgets(e)}createConfigureWidget(){return instantsearch.widgets.configure({hitsPerPage:this.config.hits?.per_page||5})}createSearchBoxWidget(){return instantsearch.widgets.searchBox({container:this.elements.inputContainer,showReset:!1,showSubmit:!1,placeholder:GLOBAL_CONFIG.lang?.search?.placeholder||"Search by keywords",showLoadingIndicator:!1,searchAsYouType:!0})}createStatsWidget(){return instantsearch.widgets.stats({container:this.elements.statsContainer,templates:{text:e=>this.formatStatsText(e)}})}formatStatsText(e){return`<hr>${GLOBAL_CONFIG.lang?.search?.hit?.replace(/\$\{hits}/,e.nbHits)?.replace(/\$\{time}/,e.processingTimeMS)||`Found ${e.nbHits} results, took ${e.processingTimeMS} ms`}`}createHitsWidget(){return instantsearch.widgets.hits({container:"#algolia-hits",templates:{item:e=>this.renderHitItem(e),empty:e=>this.renderEmptyState(e)},cssClasses:{item:"algolia-hit-item"}})}renderHitItem(e){try{const t=e.permalink||GLOBAL_CONFIG.root+e.path,i=e._highlightResult;return this.hideLoadingIndicator(),this.delayedFocus(),`\n                <a href="${this.escapeHtml(t)}" class="algolia-hit-item-link">\n                    <span class="algolia-hits-item-title">${i.title?.value||"无标题"}</span>\n                </a>`}catch(e){return console.error("Failed to render search result item:",e),'<div class="algolia-hit-error">Failed to render</div>'}}renderEmptyState(e){this.hideLoadingIndicator(),this.delayedFocus();return`<div id="algolia-hits-empty">${GLOBAL_CONFIG.lang?.search?.empty?.replace(/\$\{query}/,e.query)||`No results found for "${e.query}"`}</div>`}hideLoadingIndicator(){const e=document.querySelector("#algolia-hits .loading");e&&(e.style.display="none")}delayedFocus(){setTimeout((()=>{const e=document.querySelector("#algolia-search .ais-SearchBox-input");e?.focus()}),200)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}createPaginationWidget(){return instantsearch.widgets.pagination({container:this.elements.paginationContainer,totalPages:this.config.hits?.per_page??5,scrollTo:!1,showFirstLast:!1,templates:{first:'<i class="solitude fas fa-angles-left"></i>',last:'<i class="solitude fas fa-angles-right"></i>',previous:'<i class="solitude fas fa-angle-left"></i>',next:'<i class="solitude fas fa-angle-right"></i>'},cssClasses:{root:"pagination",item:"pagination-item",link:"page-number",active:"current",disabled:"disabled-item"}})}bindEvents(){this.bindSearchEvents(),this.bindRightMenuSearch(),this.bindPjaxEvents()}bindSearchEvents(){this.elements.searchButton&&utils.addEventListenerPjax(this.elements.searchButton,"click",(()=>this.openSearch())),this.elements.closeButton&&this.elements.closeButton.addEventListener("click",(()=>this.closeSearch())),this.elements.searchMask&&this.elements.searchMask.addEventListener("click",(()=>this.closeSearch()))}bindRightMenuSearch(){GLOBAL_CONFIG.right_menu&&this.elements.menuSearch&&this.elements.menuSearch.addEventListener("click",(()=>{if(rm.hideRightMenu(),this.openSearch(),window.selectTextNow){const e=document.querySelector(".ais-SearchBox-input");if(e){e.value=window.selectTextNow;const t=new Event("input",{bubbles:!0});e.dispatchEvent(t)}}}))}bindPjaxEvents(){window.addEventListener("pjax:complete",(()=>{utils.isHidden(this.elements.searchMask)||this.closeSearch(),this.elements=this.cacheElements(),this.bindSearchEvents()})),window.pjax&&this.searchInstance&&this.searchInstance.on("render",(()=>{const e=document.getElementById("algolia-hits");e&&window.pjax.refresh(e)}))}bindKeyboardShortcuts(){document.addEventListener("keydown",(e=>{if(e.ctrlKey&&"k"===e.key)return e.preventDefault(),void this.openSearch();"Escape"===e.code&&this.isSearchOpen()&&this.closeSearch()}))}openSearch(){this.elements.searchMask&&this.elements.searchDialog&&(utils.animateIn(this.elements.searchMask,"to_show 0.5s"),this.elements.searchDialog.style.display="flex",setTimeout((()=>{const e=document.querySelector("#algolia-search .ais-SearchBox-input");e?.focus()}),100),this.fixSafariHeight(),window.addEventListener("resize",this.fixSafariHeight),window.openSearch=()=>this.openSearch())}closeSearch(){this.elements.searchMask&&this.elements.searchDialog&&(utils.animateOut(this.elements.searchDialog,"search_close .5s"),utils.animateOut(this.elements.searchMask,"to_hide 0.5s"),window.removeEventListener("resize",this.fixSafariHeight))}isSearchOpen(){return"flex"===this.elements.searchDialog?.style.display}fixSafariHeight=()=>{window.innerWidth<768&&this.elements.searchDialog&&this.elements.searchDialog.style.setProperty("--search-height",`${window.innerHeight}px`)};destroy(){this.searchInstance&&(this.searchInstance.dispose(),this.searchInstance=null),this.isInitialized=!1}}document.addEventListener("DOMContentLoaded",(()=>{window.algoliaSearch=new AlgoliaSearch}));