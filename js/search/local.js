class LocalSearch{constructor(){this.store=[],this.currentQuery="",this.currentPage=0,this.resultsPerPage=10,this.currentResults=[],this.isLoading=!1,this.searchTimeout=null,this.elements=this.cacheElements(),this.init()}cacheElements(){return{searchMask:document.getElementById("search-mask"),searchDialog:document.querySelector("#local-search .search-dialog"),searchInput:document.getElementById("search-input"),searchResults:document.getElementById("search-results"),searchPagination:document.getElementById("search-pagination"),searchTips:document.getElementById("search-tips"),searchButton:document.querySelector("#search-button > .search"),closeButton:document.querySelector("#local-search .search-close-button"),menuSearch:document.getElementById("menu-search")}}async init(){try{await this.loadSearchData(),this.bindEvents(),this.bindKeyboardShortcuts()}catch(e){console.error("Search initialization failed:",e)}}async loadSearchData(){if(!GLOBAL_CONFIG?.localsearch?.path)throw new Error("Search data path not configured");this.isLoading=!0;try{const e=await fetch(GLOBAL_CONFIG.localsearch.path);if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const t=await e.text();this.parseSearchData(t)}catch(e){throw new Error(`Failed to load search data: ${e.message}`)}finally{this.isLoading=!1}}parseSearchData(e){try{const t=new DOMParser,s=t.parseFromString(e,"text/xml").getElementsByTagName("entry");this.store=Array.from(s).map((e=>{const t=t=>{const s=e.getElementsByTagName(t)[0];return s?s.textContent.trim():""};return{title:t("title"),link:t("url"),content:t("content")}})).filter((e=>e.title&&e.link))}catch(e){throw new Error(`Failed to parse search data: ${e.message}`)}}bindEvents(){this.elements.searchInput?.addEventListener("input",this.debounce((e=>{this.handleSearchInput(e.target.value.trim())}),300)),this.elements.searchButton?.addEventListener("click",(()=>this.openSearch())),this.elements.closeButton?.addEventListener("click",(()=>this.closeSearch())),this.elements.searchMask?.addEventListener("click",(()=>this.closeSearch())),this.bindTagListEvents(),GLOBAL_CONFIG.right_menu&&this.elements.menuSearch&&this.elements.menuSearch.addEventListener("click",(()=>{rm.hideRightMenu(),this.openSearch(),window.selectTextNow&&(this.elements.searchInput.value=window.selectTextNow,this.handleSearchInput(window.selectTextNow))})),window.addEventListener("pjax:complete",(()=>{this.elements=this.cacheElements(),this.bindEvents()}))}bindTagListEvents(){document.querySelectorAll("#local-search .tag-list").forEach((e=>{e.addEventListener("click",(()=>this.closeSearch()))}))}bindKeyboardShortcuts(){document.addEventListener("keydown",(e=>{if(e.ctrlKey&&"k"===e.key)return e.preventDefault(),void this.openSearch();"Escape"===e.code&&this.isSearchOpen()&&this.closeSearch()}))}openSearch(){this.elements.searchMask&&this.elements.searchDialog&&(utils.animateIn(this.elements.searchMask,"to_show 0.5s"),this.elements.searchDialog.style.display="flex",setTimeout((()=>{this.elements.searchInput?.focus()}),100),this.fixSafariHeight(),window.addEventListener("resize",this.fixSafariHeight),window.openSearch=()=>this.openSearch())}closeSearch(){this.elements.searchMask&&this.elements.searchDialog&&(utils.animateOut(this.elements.searchDialog,"search_close .5s"),utils.animateOut(this.elements.searchMask,"to_hide 0.5s"),window.removeEventListener("resize",this.fixSafariHeight),this.currentQuery="",this.currentPage=0)}isSearchOpen(){return"flex"===this.elements.searchDialog?.style.display}fixSafariHeight=()=>{window.innerWidth<768&&this.elements.searchDialog&&this.elements.searchDialog.style.setProperty("--search-height",`${window.innerHeight}px`)};handleSearchInput(e){if(!this.isLoading)if(this.currentQuery=e,this.currentPage=0,""!==e)try{const t=performance.now();this.currentResults=this.performSearch(e);const s=(performance.now()-t).toFixed(2);this.renderResults(this.currentResults,this.currentPage,s),this.renderPagination(this.currentResults.length)}catch(e){console.error("Search error:",e),this.showErrorMessage("Search failed, please try again")}else this.clearSearchResults()}performSearch(e){if(!e||!this.store.length)return[];const t=e.toLowerCase().split(/\s+/).filter((e=>e.length>0));return 0===t.length?[]:this.store.filter((e=>{const s=e.title.toLowerCase(),r=e.content.toLowerCase();return t.every((e=>s.includes(e)||r.includes(e)))})).sort(((e,s)=>{const r=this.calculateRelevanceScore(e,t);return this.calculateRelevanceScore(s,t)-r}))}calculateRelevanceScore(e,t){let s=0;const r=e.title.toLowerCase();return t.forEach((t=>{r===t?s+=10:r.includes(t)?s+=5:e.content.toLowerCase().includes(t)&&(s+=1)})),s}renderResults(e,t,s=null){if(!this.elements.searchResults||!this.elements.searchTips)return;this.elements.searchResults.innerHTML="",this.elements.searchTips.innerHTML="";const r=t*this.resultsPerPage,n=r+this.resultsPerPage;if(!e.length)return void this.showEmptyMessage();const a=document.createDocumentFragment();e.slice(r,n).forEach((e=>{const t=this.createResultElement(e);a.appendChild(t)})),this.elements.searchResults.appendChild(a),this.showResultCount(e.length,s)}createResultElement(e){const t=document.createElement("li");t.className="search-result-item";const s=document.createElement("a");return s.className="search-result-title",s.href=e.link,s.innerHTML=this.highlightKeywords(e.title,this.currentQuery),t.appendChild(s),t}highlightKeywords(e,t){if(!t)return e;const s=t.split(/\s+/).filter((e=>e.length>0));let r=e;return s.forEach((e=>{const t=new RegExp(`(${this.escapeRegExp(e)})`,"gi");r=r.replace(t,"<em>$1</em>")})),r}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}renderPagination(e){if(!this.elements.searchPagination)return;const t=Math.ceil(e/this.resultsPerPage);if(this.elements.searchPagination.innerHTML="",t<=1)return;const s=document.createElement("ul");s.className="pagination-list";for(let e=0;e<t;e++){const t=this.createPaginationButton(e+1,e===this.currentPage);t.addEventListener("click",(()=>this.goToPage(e))),s.appendChild(t)}this.elements.searchPagination.appendChild(s)}createPaginationButton(e,t){const s=document.createElement("li");return s.className="pagination-item",s.textContent=e,t&&s.classList.add("select"),s}goToPage(e){this.currentPage=e,this.renderResults(this.currentResults,e),document.querySelectorAll(".pagination-item").forEach(((t,s)=>{t.classList.toggle("select",s===e)}))}showEmptyMessage(){const e=document.createElement("span");e.className="search-result-empty",e.textContent=GLOBAL_CONFIG.lang?.search?.empty?.replace(/\$\{query}/,this.currentQuery)||`没有找到与 "${this.currentQuery}" 相关的内容`,this.elements.searchResults.appendChild(e)}showResultCount(e,t){const s=document.createElement("span");s.className="search-result-count",s.innerHTML=GLOBAL_CONFIG.lang?.search?.hit?.replace(/\$\{hits}/,e).replace(/\$\{time}/,t),this.elements.searchTips.appendChild(s)}showErrorMessage(e){if(!this.elements.searchResults)return;this.elements.searchResults.innerHTML="";const t=document.createElement("span");t.className="search-result-error",t.textContent=e,this.elements.searchResults.appendChild(t)}clearSearchResults(){this.elements.searchResults&&(this.elements.searchResults.innerHTML=""),this.elements.searchPagination&&(this.elements.searchPagination.innerHTML=""),this.elements.searchTips&&(this.elements.searchTips.innerHTML=""),this.currentResults=[],this.currentPage=0}debounce(e,t){return(...s)=>{clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout((()=>e.apply(this,s)),t)}}}window.addEventListener("load",(()=>{window.localSearch=new LocalSearch}));